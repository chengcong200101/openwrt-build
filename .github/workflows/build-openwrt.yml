name: Build OpenWrt x86 with Plugins

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  TARGET: x86
  SUBTARGET: 64
  PROFILE: generic

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 240

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          python3-pip \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget \
          cmake \
          ninja-build \
          pkg-config \
          swig \
          libc6-dev \
          gperf

    - name: Clone OpenWrt source
      run: |
        git clone https://git.openwrt.org/openwrt/openwrt.git openwrt
        cd openwrt
        git checkout v23.05.6

    - name: Setup feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Install third-party plugins
      run: |
        cd openwrt
        
        echo "=== 开始安装第三方插件 ==="
        
        # 主题类
        git clone --depth=1 https://github.com/jerrykuku/luci-theme-argon.git package/luci-theme-argon
        
        # DNS 相关
        git clone --depth=1 https://github.com/pymumu/openwrt-smartdns.git package/smartdns
        git clone --depth=1 https://github.com/pymumu/luci-app-smartdns.git package/luci-app-smartdns
        git clone --depth=1 https://github.com/rufengsuixing/luci-app-adguardhome.git package/luci-app-adguardhome
        
        # 网络工具
        git clone --depth=1 https://github.com/sirpdboy/luci-app-ddns-go.git package/luci-app-ddns-go
        git clone --depth=1 https://github.com/sirpdboy/luci-app-lucky.git package/luci-app-lucky
        git clone --depth=1 https://github.com/sirpdboy/luci-app-turboacc.git package/luci-app-turboacc
        git clone --depth=1 https://github.com/sirpdboy/luci-app-zerotier.git package/luci-app-zerotier
        
        # 系统工具
        git clone --depth=1 https://github.com/sirpdboy/luci-app-netdata.git package/luci-app-netdata
        git clone --depth=1 https://github.com/sirpdboy/luci-app-ttyd.git package/luci-app-ttyd
        git clone --depth=1 https://github.com/sirpdboy/luci-app-autoupdate.git package/luci-app-autoupdate
        git clone --depth=1 https://github.com/sirpdboy/luci-app-attendedsysupgrade.git package/luci-app-attendedsysupgrade
        git clone --depth=1 https://github.com/sirpdboy/luci-app-package-manager.git package/luci-app-package-manager
        
        # 控制类
        git clone --depth=1 https://github.com/jerrykuku/luci-app-control-webrestriction.git package/luci-app-control-webrestriction
        git clone --depth=1 https://github.com/jerrykuku/luci-app-control-weburl.git package/luci-app-control-weburl
        
        # 服务类
        git clone --depth=1 https://github.com/sirpdboy/luci-app-vsftpd.git package/luci-app-vsftpd
        git clone --depth=1 https://github.com/sirpdboy/luci-app-wol.git package/luci-app-wol
        git clone --depth=1 https://github.com/sirpdboy/luci-app-upnp.git package/luci-app-upnp
        
        echo "=== 插件安装完成 ==="

    - name: Create configuration
      run: |
        cd openwrt
        
        # 创建基础配置
        cat > .config << 'EOF'
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_x86_64_DEVICE_generic=y
CONFIG_TARGET_ARCH_PACKAGES="x86_64"
CONFIG_DEFAULT_TARGET_OPTIMIZATION="-Os -pipe -mcpu=generic"
CONFIG_CPU_TYPE="generic"

# 基础系统
CONFIG_BUSYBOX_CUSTOM=y
CONFIG_BUSYBOX_CONFIG_DEFAULT=y
CONFIG_DEFAULT_busybox=y
CONFIG_DEFAULT_dnsmasq=y
CONFIG_DEFAULT_dropbear=y
CONFIG_DEFAULT_firewall=y
CONFIG_DEFAULT_fstools=y
CONFIG_DEFAULT_libc=y
CONFIG_DEFAULT_libgcc=y
CONFIG_DEFAULT_logd=y
CONFIG_DEFAULT_luci=y
CONFIG_DEFAULT_mtd=y
CONFIG_DEFAULT_netifd=y
CONFIG_DEFAULT_opkg=y
CONFIG_DEFAULT_ppp=y
CONFIG_DEFAULT_ppp-mod-pppoe=y
CONFIG_DEFAULT_procd=y
CONFIG_DEFAULT_swconfig=y
CONFIG_DEFAULT_uclibcxx=y
CONFIG_DEFAULT_uclient-fetch=y
CONFIG_DEFAULT_urandom-seed=y
CONFIG_DEFAULT_urngd=y

# 必要内核模块
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_kmod-usb-storage=y
CONFIG_PACKAGE_kmod-usb2=y

# Luci 基础
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-lib-base=y
CONFIG_PACKAGE_luci-lib-ipkg=y
CONFIG_PACKAGE_luci-mod-admin-full=y
CONFIG_PACKAGE_luci-theme-bootstrap=y

# 所有请求的插件
CONFIG_PACKAGE_luci-app-adguardhome=y
CONFIG_PACKAGE_luci-app-attendedsysupgrade=y
CONFIG_PACKAGE_luci-app-autoupdate=y
CONFIG_PACKAGE_luci-app-control-webrestriction=y
CONFIG_PACKAGE_luci-app-control-weburl=y
CONFIG_PACKAGE_luci-app-ddns-go=y
CONFIG_PACKAGE_luci-app-firewall=y
CONFIG_PACKAGE_luci-app-lucky=y
CONFIG_PACKAGE_luci-app-netdata=y
CONFIG_PACKAGE_luci-app-package-manager=y
CONFIG_PACKAGE_luci-app-smartdns=y
CONFIG_PACKAGE_luci-app-ttyd=y
CONFIG_PACKAGE_luci-app-turboacc=y
CONFIG_PACKAGE_luci-app-upnp=y
CONFIG_PACKAGE_luci-app-vsftpd=y
CONFIG_PACKAGE_luci-app-wol=y
CONFIG_PACKAGE_luci-app-zerotier=y
CONFIG_PACKAGE_luci-theme-argon=y

# 插件依赖
CONFIG_PACKAGE_adguardhome=y
CONFIG_PACKAGE_smartdns=y
CONFIG_PACKAGE_ddns-go=y
CONFIG_PACKAGE_zerotier=y
CONFIG_PACKAGE_ttyd=y
CONFIG_PACKAGE_vsftpd=y
CONFIG_PACKAGE_wol=y
CONFIG_PACKAGE_upnp=y
EOF

    - name: Configure build
      run: |
        cd openwrt
        make defconfig
        echo "=== 配置摘要 ==="
        echo "目标平台: x86/64"
        echo "启用的插件数量: $(grep "CONFIG_PACKAGE_luci" .config | grep "=y" | wc -l)"

    - name: Download sources
      run: |
        cd openwrt
        make -j$(nproc) download

    - name: Build toolchain
      run: |
        cd openwrt
        make -j$(nproc) tools/install
        make -j$(nproc) toolchain/install

    - name: Build firmware
      run: |
        cd openwrt
        echo "=== 开始编译固件 ==="
        make -j$(($(nproc) - 1)) 2>&1 | tee build.log || {
          echo "编译失败，显示最后错误:"
          tail -50 build.log
          exit 1
        }

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: openwrt-x86-firmware
        path: openwrt/bin/targets/x86/64/
        retention-days: 7

    - name: Upload build logs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs
        path: openwrt/build.log
        retention-days: 30
