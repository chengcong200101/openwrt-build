name: Build OpenWrt x86 with Custom Packages

on:
  workflow_dispatch:
    inputs:
      skip_checks:
        description: 'Skip dependency checks'
        required: false
        default: false
        type: boolean

env:
  REPO_URL: https://github.com/openwrt/openwrt.git
  REPO_BRANCH: v23.05.6

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 180

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Docker build environment
      run: |
        # 使用官方 OpenWrt 构建镜像
        docker pull openwrtorg/sdk:x86_64-23.05.6
        echo "Docker environment ready"

    - name: Create build script
      run: |
        cat > build-openwrt.sh << 'EOF'
        #!/bin/bash
        set -e

        echo "Starting OpenWrt build in Docker..."

        # 克隆 OpenWrt 源码
        git clone --depth=1 --branch $REPO_BRANCH $REPO_URL /openwrt
        cd /openwrt

        # 配置 feeds
        cat > feeds.conf.default << 'FEEDS_EOF'
        src-git packages https://github.com/openwrt/packages.git;openwrt-23.05
        src-git luci https://github.com/openwrt/luci.git;openwrt-23.05
        src-git routing https://github.com/openwrt/routing.git;openwrt-23.05
        src-git telephony https://github.com/openwrt/telephony.git;openwrt-23.05
        src-git passwall_packages https://github.com/xiaorouji/openwrt-passwall-packages.git;main
        src-git passwall https://github.com/xiaorouji/openwrt-passwall.git;main
        src-git openclash https://github.com/vernesong/OpenClash.git;master
        src-git adguardhome https://github.com/rufengsuixing/luci-app-adguardhome.git;main
        src-git smartdns https://github.com/pymumu/smartdns.git;master
        src-git zerotier https://github.com/zerotier/openwrt-zerotier.git;1.10.6
        src-git ddns_go https://github.com/sirpdboy/luci-app-ddns-go.git;main
        src-git lucky https://github.com/sirpdboy/luci-app-lucky.git;main
        src-git netdata https://github.com/sirpdboy/luci-app-netdata.git;main
        src-git turboacc https://github.com/chenmozhijin/turboacc.git;main
        src-git autoupdate https://github.com/sirpdboy/luci-app-autoupdate.git;main
        src-git control https://github.com/sirpdboy/luci-app-control.git;main
        FEEDS_EOF

        # 更新和安装 feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a

        # 安装特定包
        packages=(
          "luci-app-adguardhome"
          "luci-app-attendedsysupgrade"
          "luci-app-autoupdate"
          "luci-app-control-webrestriction"
          "luci-app-control-weburl"
          "luci-app-ddns-go"
          "luci-app-firewall"
          "luci-app-lucky"
          "luci-app-netdata"
          "luci-app-openclash"
          "luci-app-package-manager"
          "luci-app-passwall"
          "luci-app-smartdns"
          "luci-app-ttyd"
          "luci-app-turboacc"
          "luci-app-upnp"
          "luci-app-vsftpd"
          "luci-app-wol"
          "luci-app-zerotier"
          "luci-theme-argon"
        )
        
        for pkg in "${packages[@]}"; do
          echo "Installing $pkg..."
          ./scripts/feeds install $pkg || echo "Failed to install $pkg, continuing..."
        done

        # 配置 OpenWrt
        make defconfig

        # 设置配置
        cat >> .config << 'CONFIG_EOF'
        CONFIG_TARGET_x86=y
        CONFIG_TARGET_x86_64=y
        CONFIG_TARGET_x86_generic=y
        CONFIG_TARGET_x86_generic_Generic=y
        CONFIG_TARGET_ROOTFS_PARTSIZE=2048
        CONFIG_TARGET_KERNEL_PARTSIZE=256
        CONFIG_PACKAGE_kmod-usb-core=y
        CONFIG_PACKAGE_kmod-usb-ohci=y
        CONFIG_PACKAGE_kmod-usb-uhci=y
        CONFIG_PACKAGE_kmod-usb2=y
        CONFIG_PACKAGE_kmod-usb3=y
        CONFIG_PACKAGE_kmod-usb-storage=y
        CONFIG_PACKAGE_luci-app-adguardhome=y
        CONFIG_PACKAGE_luci-app-attendedsysupgrade=y
        CONFIG_PACKAGE_luci-app-autoupdate=y
        CONFIG_PACKAGE_luci-app-control-webrestriction=y
        CONFIG_PACKAGE_luci-app-control-weburl=y
        CONFIG_PACKAGE_luci-app-ddns-go=y
        CONFIG_PACKAGE_luci-app-firewall=y
        CONFIG_PACKAGE_luci-app-lucky=y
        CONFIG_PACKAGE_luci-app-netdata=y
        CONFIG_PACKAGE_luci-app-openclash=y
        CONFIG_PACKAGE_luci-app-package-manager=y
        CONFIG_PACKAGE_luci-app-passwall=y
        CONFIG_PACKAGE_luci-app-smartdns=y
        CONFIG_PACKAGE_luci-app-ttyd=y
        CONFIG_PACKAGE_luci-app-turboacc=y
        CONFIG_PACKAGE_luci-app-upnp=y
        CONFIG_PACKAGE_luci-app-vsftpd=y
        CONFIG_PACKAGE_luci-app-wol=y
        CONFIG_PACKAGE_luci-app-zerotier=y
        CONFIG_PACKAGE_luci-theme-argon=y
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-compat=y
        CONFIG_PACKAGE_luci-ssl=y
        CONFIG_PACKAGE_luci-proto-ipv6=y
        CONFIG_PACKAGE_luci-proto-ppp=y
        CONFIG_PACKAGE_ipv6helper=y
        CONFIG_PACKAGE_ddns-scripts=y
        CONFIG_PACKAGE_ddns-scripts-cloudflare=y
        CONFIG_PACKAGE_automount=y
        CONFIG_PACKAGE_block-mount=y
        CONFIG_PACKAGE_openssh-sftp-server=y
        CONFIG_PACKAGE_htop=y
        CONFIG_PACKAGE_nano=y
        CONFIG_PACKAGE_curl=y
        CONFIG_PACKAGE_wget=y
        CONFIG_EOF

        # 更新配置
        make defconfig

        # 开始构建
        echo "Starting build process..."
        make -j$(nproc) V=s

        echo "Build completed successfully!"
        EOF

        chmod +x build-openwrt.sh

    - name: Run build in Docker container
      run: |
        # 在 Docker 容器中运行构建脚本
        docker run --rm \
          -v $(pwd)/build-openwrt.sh:/build-openwrt.sh \
          -v $(pwd)/artifacts:/artifacts \
          -e REPO_URL="${{ env.REPO_URL }}" \
          -e REPO_BRANCH="${{ env.REPO_BRANCH }}" \
          openwrtorg/sdk:x86_64-23.05.6 \
          /build-openwrt.sh

    - name: Copy artifacts from Docker
      run: |
        # 从 Docker 容器中复制构建产物
        mkdir -p openwrt-bin
        sudo cp -r artifacts/openwrt/bin/targets/x86/64/* openwrt-bin/ 2>/dev/null || echo "No artifacts found, this is normal if build failed"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: openwrt-x86-64-images
        path: openwrt-bin/*
        retention-days: 7

    - name: Alternative build method
      if: failure()
      run: |
        echo "Docker build failed, trying alternative method..."
        # 这里可以添加备选构建方法

    - name: Notify failure
      if: failure()
      run: |
        echo "Build failed! Check the logs for details."
        exit 1