name: Build OpenWrt x86_64 with Custom Packages

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenWrt Version'
        required: true
        default: 'v24.10.4'
        type: string
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * 0'

env:
  OPENWRT_VERSION: "v24.10.4"
  TARGET: "x86/64"
  SUBTARGET: "generic"
  PROFILE: "generic"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Check build environment
      run: |
        echo "=== Checking Build Environment ==="
        df -h
        echo "Available disk space:"
        df -h /dev/root | tail -1
        echo "Memory info:"
        free -h
        echo "CPU info:"
        nproc
        echo "=== Installing Dependencies ==="
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          gcc \
          g++ \
          binutils \
          patch \
          bzip2 \
          flex \
          make \
          libncurses5-dev \
          libncursesw5-dev \
          zlib1g-dev \
          gawk \
          git \
          gettext \
          xsltproc \
          rsync \
          wget \
          unzip \
          python3 \
          python3-setuptools \
          python3-pip \
          libssl-dev \
          libelf-dev \
          quilt \
          bc \
          dos2unix \
          file \
          libpam0g-dev \
          libtirpc-dev \
          liblzma-dev \
          libsnmp-dev
        echo "=== Environment Check Complete ==="
        
    - name: Clone OpenWrt source
      run: |
        echo "=== Cloning OpenWrt Source ==="
        git clone https://git.openwrt.org/openwrt/openwrt.git openwrt
        cd openwrt
        git checkout ${{ env.OPENWRT_VERSION }}
        echo "OpenWrt version:"
        git describe --tags
        cd ..
        
    - name: Prepare build environment
      run: |
        cd openwrt
        echo "=== Preparing Build Environment ==="
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Add working third-party feeds
      run: |
        cd openwrt
        echo "=== Adding Working Third-party Feeds ==="
        
        # æ¸…ç†å¯èƒ½å­˜åœ¨çš„é”™è¯¯feeds
        rm -f feeds.conf.default
        
        # é‡æ–°åˆ›å»ºfeedsé…ç½®ï¼Œåªä½¿ç”¨å¯é æ¥æº
        cat > feeds.conf.default << 'EOF'
        src-git packages https://git.openwrt.org/feed/packages.git
        src-git luci https://git.openwrt.org/project/luci.git
        src-git routing https://git.openwrt.org/feed/routing.git
        src-git telephony https://git.openwrt.org/feed/telephony.git
        src-git kenzo https://github.com/kenzok8/openwrt-packages.git
        src-git small https://github.com/kenzok8/small.git
        src-git openclash https://github.com/vernesong/OpenClash.git
        EOF
        
        # æ›´æ–°æ ¸å¿ƒfeeds
        ./scripts/feeds update -a
        
        # å…ˆå®‰è£…æ ¸å¿ƒåŒ…
        ./scripts/feeds install -a
        
        echo "=== Feeds Update Complete ==="
        
    - name: Configure build with reliable packages
      run: |
        cd openwrt
        echo "=== Configuring Build with Reliable Packages ==="
        
        # åˆ›å»ºé»˜è®¤é…ç½®
        make defconfig
        
        # é…ç½®ç›®æ ‡å¹³å°
        echo "CONFIG_TARGET_x86=y" >> .config
        echo "CONFIG_TARGET_x86_64=y" >> .config
        echo "CONFIG_TARGET_x86_64_Generic=y" >> .config
        
        # å¯ç”¨å¤§å®¹é‡å­˜å‚¨
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=2048" >> .config
        echo "CONFIG_TARGET_KERNEL_PARTSIZE=256" >> .config
        
        # å¯ç”¨å¿…è¦çš„å†…æ ¸æ¨¡å—å’Œåº“
        echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-vfat=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-ohci=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-uhci=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        
        # å¯ç”¨ç¼ºå¤±çš„ä¾èµ–åº“
        echo "CONFIG_PACKAGE_libpam=y" >> .config
        echo "CONFIG_PACKAGE_libtirpc=y" >> .config
        echo "CONFIG_PACKAGE_liblzma=y" >> .config
        echo "CONFIG_PACKAGE_libopenssl=y" >> .config
        echo "CONFIG_PACKAGE_libstdcpp=y" >> .config
        echo "CONFIG_PACKAGE_zlib=y" >> .config
        
        # é…ç½®å¯ç”¨çš„æ’ä»¶ï¼ˆä»kenzoå’Œå°åŒ…æºè·å–ï¼‰
        echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-attendedsysupgrade=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-autoupdate=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ddns-go=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-firewall=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-lucky=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-netdata=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-smartdns=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-vsftpd=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-wol=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-zerotier=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        
        # å¯ç”¨LuCI
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-ssl=y" >> .config
        echo "CONFIG_LUCI_LANG_zh_Hans=y" >> .config
        
        # æ£€æŸ¥é…ç½®
        make defconfig
        echo "=== Configuration Complete ==="
        
        # æ˜¾ç¤ºé…ç½®æ‘˜è¦
        echo "=== Configuration Summary ==="
        grep "CONFIG_PACKAGE_luci" .config | head -20
        
    - name: Install specific packages manually
      run: |
        cd openwrt
        echo "=== Manually Installing Missing Packages ==="
        
        # å°è¯•æ‰‹åŠ¨å®‰è£…ç¼ºå¤±çš„åŒ…
        # å¯¹äºæ§åˆ¶ç±»æ’ä»¶ï¼Œä½¿ç”¨æ›¿ä»£æ–¹æ¡ˆæˆ–ä»å…¶ä»–æºè·å–
        ./scripts/feeds install luci-app-passwall || echo "Passwall not available, skipping"
        
        # å®‰è£…å®¶é•¿æ§åˆ¶æ›¿ä»£æ–¹æ¡ˆ
        ./scripts/feeds install luci-app-accesscontrol || echo "Access control alternative not available"
        
        echo "=== Manual Package Installation Complete ==="
        
    - name: Check and fix dependencies
      run: |
        cd openwrt
        echo "=== Checking and Fixing Dependencies ==="
        
        # æ£€æŸ¥ç¼ºå¤±çš„ä¾èµ–
        echo "Checking for missing dependencies..."
        make -j$(nproc) tools/install V=s 2>&1 | grep -i "missing\|error\|warning" || true
        make -j$(nproc) toolchain/install V=s 2>&1 | grep -i "missing\|error\|warning" || true
        
        echo "=== Dependency Check Complete ==="
        
    - name: Download packages
      run: |
        cd openwrt
        echo "=== Downloading Packages ==="
        make -j$(nproc) download
        echo "=== Package Download Complete ==="
        
        # æ£€æŸ¥ä¸‹è½½æ˜¯å¦å®Œæ•´
        echo "=== Checking Downloaded Packages ==="
        find dl/ -name "*.zip" -o -name "*.tar.*" -o -name "*.tgz" | wc -l
        ls -la dl/ | head -10
        
    - name: Build OpenWrt
      run: |
        cd openwrt
        echo "=== Starting Build Process ==="
        
        # åˆ›å»ºæ„å»ºæ—¥å¿—ç›®å½•
        mkdir -p logs
        
        # ä½¿ç”¨è¯¦ç»†è¾“å‡ºä»¥ä¾¿è°ƒè¯•ï¼Œå¹¶ä¿å­˜åˆ°æ—¥å¿—æ–‡ä»¶
        {
          echo "=== Build Started at $(date) ==="
          set -o pipefail
          make -j$(($(nproc) + 1)) V=s 2>&1
          BUILD_EXIT_CODE=$?
          echo "=== Build Finished at $(date) with exit code: $BUILD_EXIT_CODE ==="
          
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "=== Build Failed - Creating Error Log ==="
            # ä¿å­˜æœ€å500è¡Œæ—¥å¿—
            tail -500 build.log > logs/build_error_detailed.log 2>/dev/null || true
            # æŸ¥æ‰¾é”™è¯¯ç›¸å…³çš„æ—¥å¿—
            grep -i "error\|failed\|missing" build.log > logs/build_errors.log 2>/dev/null || true
            # ä¿å­˜é…ç½®ä¿¡æ¯
            cp .config logs/ 2>/dev/null || true
            exit 1
          fi
        } | tee build.log
        
        echo "=== Build Successful ==="
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: openwrt-${{ env.OPENWRT_VERSION }}-x86_64
        path: |
          openwrt/bin/targets/x86/64/*
        retention-days: 7
        
    - name: Upload build logs on failure
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-failure-logs
        path: |
          openwrt/build.log
          openwrt/logs/
        retention-days: 30

    - name: Generate build summary
      if: always()
      run: |
        echo "=== Build Summary ==="
        echo "OpenWrt Version: ${{ env.OPENWRT_VERSION }}"
        echo "Target: ${{ env.TARGET }}"
        echo "Profile: ${{ env.PROFILE }}"
        echo "Build Status: ${{ job.status }}"
        
        if [ -d "openwrt" ]; then
          cd openwrt
          echo "=== Build Directory Info ==="
          echo "Binaries directory:"
          ls -la bin/targets/*/ 2>/dev/null || echo "No binaries built"
          
          echo "=== Available Packages Summary ==="
          echo "âœ… Core packages and dependencies configured"
          echo "âœ… Reliable third-party feeds: kenzo, small"
          echo "âœ… Most requested plugins included"
          echo "âš ï¸  Some problematic feeds removed for stability"
        fi
        
        echo "=== Repository Structure ==="
        echo "ğŸ“¦ OpenWrt Build Repository"
        echo "â”œâ”€â”€ ğŸ“ .github/workflows/"
        echo "â”‚   â””â”€â”€ build-openwrt.yml    # GitHub Actions å·¥ä½œæµ"
        echo "â”œâ”€â”€ ğŸ“ openwrt/              # OpenWrt æºç ç›®å½•"
        echo "â”‚   â”œâ”€â”€ ğŸ“ feeds/            # è½¯ä»¶æº"
        echo "â”‚   â”œâ”€â”€ ğŸ“ package/          # è½¯ä»¶åŒ…"
        echo "â”‚   â”œâ”€â”€ ğŸ“ target/           # ç›®æ ‡å¹³å°é…ç½®"
        echo "â”‚   â”œâ”€â”€ ğŸ“ logs/             # æ„å»ºæ—¥å¿—"
        echo "â”‚   â””â”€â”€ .config              # ç¼–è¯‘é…ç½®"
        echo "â””â”€â”€ ğŸ“„ README.md             # é¡¹ç›®è¯´æ˜"
        
        echo "=== Included Packages ==="
        echo "ğŸ”§ Core: luci, luci-ssl, libpam, libtirpc, liblzma"
        echo "ğŸ¨ Theme: luci-theme-argon"
        echo "ğŸ›¡ï¸ Security: adguardhome, openclash, smartdns"
        echo "ğŸŒ Network: ddns-go, zerotier, lucky, turboacc"
        echo "ğŸ› ï¸ Tools: ttyd, netdata, wol, upnp, vsftpd"
        echo "âš™ï¸ System: autoupdate, attendedsysupgrade, firewall"
        echo "ğŸ“Š Status: Build completed with status: ${{ job.status }}"