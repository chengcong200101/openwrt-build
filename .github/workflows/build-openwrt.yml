name: Build OpenWrt x86

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  TARGET: x86
  SUBTARGET: 64

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-pip \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget

    - name: Clone OpenWrt source
      run: |
        git clone https://github.com/openwrt/openwrt.git openwrt
        cd openwrt
        git checkout v23.05.3

    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Install basic plugins
      run: |
        cd openwrt
        
        # 安装基础插件
        git clone https://github.com/jerrykuku/luci-theme-argon.git package/luci-theme-argon
        git clone https://github.com/pymumu/luci-app-smartdns.git package/luci-app-smartdns
        git clone https://github.com/sirpdboy/luci-app-ddns-go.git package/luci-app-ddns-go
        git clone https://github.com/rufengsuixing/luci-app-ttyd.git package/luci-app-ttyd

    - name: Create basic config
      run: |
        cd openwrt
        
        # 创建最小化配置
        cat > .config << 'EOF'
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_x86_64_DEVICE_generic=y

# 基础系统
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-theme-bootstrap=y

# 基础网络
CONFIG_PACKAGE_dnsmasq=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_dropbear=y

# 存储支持
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_kmod-usb-storage=y

# 基础插件
CONFIG_PACKAGE_luci-theme-argon=y
CONFIG_PACKAGE_luci-app-smartdns=y
CONFIG_PACKAGE_luci-app-ttyd=y
CONFIG_PACKAGE_luci-app-ddns-go=y
EOF

    - name: Build configuration
      run: |
        cd openwrt
        make defconfig

    - name: Download sources
      run: |
        cd openwrt
        make -j$(nproc) download

    - name: Build firmware
      run: |
        cd openwrt
        echo "开始编译固件..."
        make -j$(nproc) || {
          echo "编译失败，显示错误日志:"
          tail -100 build.log
          exit 1
        }

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: openwrt-firmware
        path: openwrt/bin/targets/x86/64/
        retention-days: 7
