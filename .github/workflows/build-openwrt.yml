name: Build OpenWrt x86 with Custom Packages

on:
  workflow_dispatch:
    inputs:
      skip_checks:
        description: 'Skip dependency checks'
        required: false
        default: false
        type: boolean

env:
  REPO_URL: https://github.com/openwrt/openwrt.git
  REPO_BRANCH: v23.05.6
  FEEDS_CONF: feeds.conf.default

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 180

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          flex \
          gcc \
          g++ \
          gawk \
          gcc-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-pip \
          python3-setuptools \
          python3-venv \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget \
          qemu-utils \
          subversion \
          sudo \
          swig \
          libelf-dev \
          patchelf \
          bison \
          curl
        echo "Environment setup completed"

    - name: Clone OpenWrt source
      run: |
        git clone --depth=1 --branch ${{ env.REPO_BRANCH }} ${{ env.REPO_URL }} openwrt

    - name: Check OpenWrt structure
      working-directory: ./openwrt
      run: |
        echo "Checking OpenWrt directory structure..."
        ls -la
        echo "Feeds script exists:"
        ls -la scripts/feeds || echo "Feeds script not found"

    - name: Initialize feeds with manual method
      working-directory: ./openwrt
      run: |
        # 手动创建 feeds.conf 并初始化
        cat > feeds.conf << 'EOF'
        src-git packages https://github.com/openwrt/packages.git;openwrt-23.05
        src-git luci https://github.com/openwrt/luci.git;openwrt-23.05
        src-git routing https://github.com/openwrt/routing.git;openwrt-23.05
        src-git telephony https://github.com/openwrt/telephony.git;openwrt-23.05
        EOF
        
        # 检查并创建 feeds 目录结构
        mkdir -p feeds
        echo "Feeds directory created"

    - name: Update core feeds manually
      working-directory: ./openwrt
      run: |
        # 逐个更新核心 feeds
        echo "Updating packages feed..."
        if [ ! -d "feeds/packages" ]; then
          git clone --depth=1 https://github.com/openwrt/packages.git feeds/packages -b openwrt-23.05
        fi
        
        echo "Updating luci feed..."
        if [ ! -d "feeds/luci" ]; then
          git clone --depth=1 https://github.com/openwrt/luci.git feeds/luci -b openwrt-23.05
        fi
        
        echo "Updating routing feed..."
        if [ ! -d "feeds/routing" ]; then
          git clone --depth=1 https://github.com/openwrt/routing.git feeds/routing -b openwrt-23.05
        fi
        
        echo "Updating telephony feed..."
        if [ ! -d "feeds/telephony" ]; then
          git clone --depth=1 https://github.com/openwrt/telephony.git feeds/telephony -b openwrt-23.05
        fi
        
        echo "Core feeds updated manually"

    - name: Install core packages
      working-directory: ./openwrt
      run: |
        # 使用 feeds 脚本安装基础包
        ./scripts/feeds install -a

    - name: Add third-party feeds manually
      working-directory: ./openwrt
      run: |
        # 手动添加第三方 feeds
        echo "Adding third-party feeds manually..."
        
        # 更新 feeds.conf 包含第三方源
        cat >> feeds.conf << 'EOF'

        # Third-party feeds
        src-git passwall_packages https://github.com/xiaorouji/openwrt-passwall-packages.git;main
        src-git passwall https://github.com/xiaorouji/openwrt-passwall.git;main
        src-git openclash https://github.com/vernesong/OpenClash.git;master
        src-git adguardhome https://github.com/rufengsuixing/luci-app-adguardhome.git;main
        src-git smartdns https://github.com/pymumu/smartdns.git;master
        src-git zerotier https://github.com/zerotier/openwrt-zerotier.git;1.10.6
        src-git ddns_go https://github.com/sirpdboy/luci-app-ddns-go.git;main
        src-git lucky https://github.com/sirpdboy/luci-app-lucky.git;main
        src-git netdata https://github.com/sirpdboy/luci-app-netdata.git;main
        src-git turboacc https://github.com/chenmozhijin/turboacc.git;main
        src-git autoupdate https://github.com/sirpdboy/luci-app-autoupdate.git;main
        src-git control https://github.com/sirpdboy/luci-app-control.git;main
        EOF

        # 逐个更新第三方 feeds
        third_party_feeds=(
          "passwall_packages https://github.com/xiaorouji/openwrt-passwall-packages.git main"
          "passwall https://github.com/xiaorouji/openwrt-passwall.git main"
          "openclash https://github.com/vernesong/OpenClash.git master"
          "adguardhome https://github.com/rufengsuixing/luci-app-adguardhome.git main"
          "smartdns https://github.com/pymumu/smartdns.git master"
          "zerotier https://github.com/zerotier/openwrt-zerotier.git 1.10.6"
          "ddns_go https://github.com/sirpdboy/luci-app-ddns-go.git main"
          "lucky https://github.com/sirpdboy/luci-app-lucky.git main"
          "netdata https://github.com/sirpdboy/luci-app-netdata.git main"
          "turboacc https://github.com/chenmozhijin/turboacc.git main"
          "autoupdate https://github.com/sirpdboy/luci-app-autoupdate.git main"
          "control https://github.com/sirpdboy/luci-app-control.git main"
        )
        
        for feed_info in "${third_party_feeds[@]}"; do
          feed_name=$(echo $feed_info | cut -d' ' -f1)
          feed_url=$(echo $feed_info | cut -d' ' -f2)
          feed_branch=$(echo $feed_info | cut -d' ' -f3)
          
          echo "Adding feed: $feed_name"
          if [ ! -d "feeds/$feed_name" ]; then
            git clone --depth=1 "$feed_url" "feeds/$feed_name" -b "$feed_branch" || echo "Failed to clone $feed_name, but continuing..."
          else
            echo "Feed $feed_name already exists"
          fi
        done

    - name: Update all feeds and install packages
      working-directory: ./openwrt
      run: |
        # 使用 feeds 系统更新和安装所有包
        ./scripts/feeds update -a || echo "Some feeds update failed, but continuing..."
        ./scripts/feeds install -a

    - name: Install specific packages
      working-directory: ./openwrt
      run: |
        # 确保安装所有需要的包
        packages=(
          "luci-app-adguardhome"
          "luci-app-attendedsysupgrade"
          "luci-app-autoupdate"
          "luci-app-control-webrestriction"
          "luci-app-control-weburl"
          "luci-app-ddns-go"
          "luci-app-firewall"
          "luci-app-lucky"
          "luci-app-netdata"
          "luci-app-openclash"
          "luci-app-package-manager"
          "luci-app-passwall"
          "luci-app-smartdns"
          "luci-app-ttyd"
          "luci-app-turboacc"
          "luci-app-upnp"
          "luci-app-vsftpd"
          "luci-app-wol"
          "luci-app-zerotier"
          "luci-theme-argon"
        )
        
        for pkg in "${packages[@]}"; do
          echo "Installing $pkg..."
          ./scripts/feeds install $pkg || echo "Failed to install $pkg, but continuing..."
        done

    - name: Check dependencies
      working-directory: ./openwrt
      if: ${{ !inputs.skip_checks }}
      run: |
        echo "Checking dependencies..."
        make defconfig
        make tools/install -j$(nproc)
        make toolchain/install -j$(nproc)
        echo "Dependency check completed"

    - name: Configure OpenWrt
      working-directory: ./openwrt
      run: |
        # 应用默认配置
        make defconfig
        
        # 配置目标系统
        echo "CONFIG_TARGET_x86=y" >> .config
        echo "CONFIG_TARGET_x86_64=y" >> .config
        echo "CONFIG_TARGET_x86_generic=y" >> .config
        echo "CONFIG_TARGET_x86_generic_Generic=y" >> .config
        
        # 启用大容量存储
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=2048" >> .config
        echo "CONFIG_TARGET_KERNEL_PARTSIZE=256" >> .config
        
        # 启用必要的内核模块
        echo "CONFIG_PACKAGE_kmod-usb-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-ohci=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-uhci=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> .config
        
        # 选择所有需要的包
        packages=(
          "luci-app-adguardhome"
          "luci-app-attendedsysupgrade" 
          "luci-app-autoupdate"
          "luci-app-control-webrestriction"
          "luci-app-control-weburl"
          "luci-app-ddns-go"
          "luci-app-firewall"
          "luci-app-lucky"
          "luci-app-netdata"
          "luci-app-openclash"
          "luci-app-package-manager"
          "luci-app-passwall"
          "luci-app-smartdns"
          "luci-app-ttyd"
          "luci-app-turboacc"
          "luci-app-upnp"
          "luci-app-vsftpd"
          "luci-app-wol"
          "luci-app-zerotier"
          "luci-theme-argon"
          "luci"
          "luci-compat"
          "luci-ssl"
          "luci-proto-ipv6"
          "luci-proto-ppp"
          "ipv6helper"
          "ddns-scripts"
          "ddns-scripts-cloudflare"
          "automount"
          "block-mount"
          "openssh-sftp-server"
          "htop"
          "nano"
          "curl"
          "wget"
        )
        
        for pkg in "${packages[@]}"; do
          echo "CONFIG_PACKAGE_${pkg}=y" >> .config
        done
        
        # 更新配置
        make defconfig

    - name: Build OpenWrt
      working-directory: ./openwrt
      continue-on-error: false
      run: |
        # 开始编译，启用详细输出
        echo "Starting build process..."
        set -o pipefail
        make -j$(nproc) V=s 2>&1 | tee build.log || (echo "Build failed, creating error log..." && tail -n 500 build.log > build_error.log && exit 1)

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: openwrt-x86-64-images
        path: |
          openwrt/bin/targets/x86/64/*.img.gz
          openwrt/bin/targets/x86/64/*.kernel
          openwrt/bin/targets/x86/64/sha256sums
        retention-days: 7

    - name: Upload build log on failure
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-error-logs
        path: |
          openwrt/build.log
          openwrt/build_error.log
        retention-days: 7

    - name: Cleanup on success
      if: success()
      run: |
        echo "Build completed successfully!"
        du -sh openwrt/bin/targets/x86/64/*

    - name: Notify failure
      if: failure()
      run: |
        echo "Build failed! Check the build-error-logs artifact for details."
        exit 1