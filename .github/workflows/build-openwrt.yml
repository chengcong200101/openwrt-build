name: Build OpenWrt x86_64 with Complete Plugin Set

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenWrt Version'
        required: true
        default: 'v24.10.4'
        type: string
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * 0'

env:
  OPENWRT_VERSION: "v24.10.4"
  TARGET: "x86/64"
  SUBTARGET: "generic"
  PROFILE: "generic"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: Check available disk space
      run: |
        echo "=== Initial Disk Space Check ==="
        df -h
        echo "Available space in /home/runner:"
        df -h /home/runner | tail -1
        echo "Available space in /:"
        df -h / | tail -1
        
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Cache OpenWrt downloads
      uses: actions/cache@v3
      with:
        path: openwrt/dl
        key: openwrt-dl-${{ hashFiles('**/.config') }}-${{ github.sha }}
        restore-keys: |
          openwrt-dl-${{ hashFiles('**/.config') }}-
          openwrt-dl-
      
    - name: Install only essential dependencies
      run: |
        echo "=== Installing Essential Dependencies ==="
        sudo apt-get update
        # 清理apt缓存
        sudo apt-get clean
        
        # 只安装最必要的依赖
        sudo apt-get install -y \
          build-essential \
          clang \
          gcc \
          g++ \
          binutils \
          patch \
          bzip2 \
          flex \
          make \
          libncurses5-dev \
          zlib1g-dev \
          gawk \
          git \
          gettext \
          xsltproc \
          rsync \
          wget \
          unzip \
          python3 \
          python3-pip \
          libssl-dev \
          libelf-dev \
          quilt \
          bc \
          file
        
        # 清理临时文件
        sudo apt-get autoremove -y
        sudo apt-get clean
        
    - name: Clone OpenWrt source with shallow clone
      run: |
        echo "=== Cloning OpenWrt Source (Shallow) ==="
        # 动态选择版本：优先使用手动输入的版本，否则使用环境变量默认值
        OPENWRT_BRANCH="${{ github.event.inputs.version || env.OPENWRT_VERSION }}"
        echo "Using OpenWrt version: $OPENWRT_BRANCH"
        
        # 使用浅克隆减少磁盘使用
        git clone --depth 1 --branch "$OPENWRT_BRANCH" \
          https://git.openwrt.org/openwrt/openwrt.git openwrt
        cd openwrt
        echo "OpenWrt version:"
        git describe --tags || echo "Shallow clone, using branch $OPENWRT_BRANCH"
        
    - name: Clean up space before build
      run: |
        echo "=== Cleaning Disk Space Before Build ==="
        df -h
        
        # 清理各种缓存
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/graalvm
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo rm -rf /opt/microsoft
        sudo rm -rf /usr/local/lib/android
        
        # 清理日志文件
        sudo find /var/log -type f -name "*.log" -exec truncate -s 0 {} \;
        
        echo "Space after cleanup:"
        df -h
        
    - name: Configure OpenWrt with Complete Plugin Set
      run: |
        cd openwrt
        echo "=== Configuring OpenWrt with Complete Plugin Set ==="
        
        # 设置git配置以应对可能的网络问题
        git config --global http.sslVerify false
        git config --global http.postBuffer 1048576000
        
        # 更新基础feeds，使用重试机制
        echo "=== Updating Feeds with Retry ==="
        for i in {1..3}; do
          if ./scripts/feeds update -a; then
            echo "Feeds update successful on attempt $i"
            break
          else
            echo "Feeds update failed on attempt $i, retrying..."
            if [ $i -eq 3 ]; then
              echo "Feeds update failed after 3 attempts, continuing with available feeds"
            fi
            sleep 10
          fi
        done
        
        # 安装feeds
        ./scripts/feeds install -a
        
        # 创建默认配置
        make defconfig
        
        # 配置目标平台
        echo "CONFIG_TARGET_x86=y" >> .config
        echo "CONFIG_TARGET_x86_64=y" >> .config
        echo "CONFIG_TARGET_x86_64_Generic=y" >> .config
        
        # 使用稍大的分区大小以容纳更多插件
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=1024" >> .config
        echo "CONFIG_TARGET_KERNEL_PARTSIZE=256" >> .config
        
        # 启用必要的内核模块
        echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nft-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nft-offload=y" >> .config
        
        # ===== 添加所有请求的 LuCI 插件 =====
        
        # DNS/广告过滤类
        echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-smartdns=y" >> .config
        
        # 系统升级类
        echo "CONFIG_PACKAGE_luci-app-attendedsysupgrade=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-autoupdate=y" >> .config
        
        # 网络控制类
        echo "CONFIG_PACKAGE_luci-app-control-webrestriction=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-control-weburl=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-firewall=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        
        # DDNS 类
        echo "CONFIG_PACKAGE_luci-app-ddns-go=y" >> .config
        
        # 代理/VPN 类
        echo "CONFIG_PACKAGE_luci-app-lucky=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-zerotier=y" >> .config
        
        # 监控/统计类
        echo "CONFIG_PACKAGE_luci-app-netdata=y" >> .config
        
        # 系统工具类
        echo "CONFIG_PACKAGE_luci-app-package-manager=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-wol=y" >> .config
        
        # 文件服务类
        echo "CONFIG_PACKAGE_luci-app-vsftpd=y" >> .config
        
        # 主题
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        
        # 启用LuCI核心
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-ssl=y" >> .config
        
        # ===== 添加中文语言支持 =====
        echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-firewall-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-upnp-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-wol-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-attendedsysupgrade-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-ttyd-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-vsftpd-zh-cn=y" >> .config
        
        # 设置中文为默认语言
        echo "CONFIG_LUCI_LANG_zh-cn=y" >> .config
        
        # ===== 添加必要的依赖包 =====
        echo "CONFIG_PACKAGE_adguardhome=y" >> .config
        echo "CONFIG_PACKAGE_smartdns=y" >> .config
        echo "CONFIG_PACKAGE_ddns-go=y" >> .config
        echo "CONFIG_PACKAGE_lucky=y" >> .config
        echo "CONFIG_PACKAGE_openclash=y" >> .config
        echo "CONFIG_PACKAGE_zerotier=y" >> .config
        echo "CONFIG_PACKAGE_netdata=y" >> .config
        echo "CONFIG_PACKAGE_vsftpd=y" >> .config
        echo "CONFIG_PACKAGE_ttyd=y" >> .config
        
        # 禁用调试信息以节省空间
        echo "CONFIG_DEBUG_INFO=n" >> .config
        echo "# CONFIG_DEBUG is not set" >> .config
        
        # 检查配置
        make defconfig
        
        echo "=== Complete Plugin Configuration Complete ==="
        echo "Selected packages:"
        grep "^CONFIG_PACKAGE" .config | head -30
        echo "Chinese language packages:"
        grep "zh-cn" .config
        
    - name: Download packages with retry mechanism
      run: |
        cd openwrt
        echo "=== Downloading Packages with Retry ==="
        
        # 动态设置并行下载数量，使用重试机制
        echo "CPU cores: $(nproc)"
        for i in {1..3}; do
          if make -j$(nproc) download; then
            echo "Package download successful on attempt $i"
            break
          else
            echo "Package download failed on attempt $i, retrying..."
            if [ $i -eq 3 ]; then
              echo "Package download failed after 3 attempts, continuing with available packages"
            fi
            sleep 10
          fi
        done
        
        echo "=== Package Download Complete ==="
        echo "Download cache size:"
        du -sh dl/ || echo "dl directory not found"
        
    - name: Build with space optimization
      run: |
        cd openwrt
        echo "=== Starting Optimized Build ==="
        
        # 监控磁盘空间
        df -h
        
        # 创建构建脚本，包含空间监控和增强的错误处理
        cat > build_with_monitor.sh << 'EOF'
        #!/bin/bash
        set -e
        
        # 磁盘空间监控函数
        monitor_space() {
            while true; do
                echo "=== Disk Space Monitor ==="
                df -h /home/runner
                sleep 30
            done
        }
        
        # 构建函数，包含错误检查
        build_openwrt() {
            echo "=== Building Toolchain ==="
            # 使用重试机制构建工具链
            for i in {1..2}; do
              if make -j$(nproc) tools/install; then
                echo "Toolchain build successful"
                break
              else
                echo "Toolchain build failed on attempt $i"
                if [ $i -eq 2 ]; then
                  return 1
                fi
                echo "Retrying toolchain build..."
              fi
            done
            
            echo "=== Building Target ==="
            # 使用动态并行进程
            if make -j$(nproc) V=s 2>&1 | tee build.log; then
                echo "Make command completed successfully"
            else
                echo "Make command failed"
                return 1
            fi
            
            # 检查构建结果
            if [ -f "bin/targets/x86/64/openwrt-x86-64-generic-kernel.bin" ] || \
               [ -f "bin/targets/x86/64/openwrt-x86-64-generic-ext4-combined.img.gz" ] || \
               [ -f "bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined.img.gz" ]; then
                echo "✅ Build successful!"
                return 0
            else
                echo "❌ Build failed - no target binaries found!"
                # 列出bin目录内容以便调试
                echo "Contents of bin/targets:"
                find bin/targets -type f 2>/dev/null | head -20 || echo "No bin/targets directory"
                return 1
            fi
        }
        
        # 启动监控后台进程
        monitor_space &
        MONITOR_PID=$!
        
        # 设置trap确保监控进程在脚本退出时被终止
        trap "echo 'Cleaning up monitor process'; kill $MONITOR_PID 2>/dev/null || true; exit" EXIT INT TERM
        
        # 执行构建
        if build_openwrt; then
            echo "=== Build Completed Successfully ==="
            
            # 显示最终镜像信息
            echo "=== Generated Images ==="
            find bin/targets -name "*.img" -o -name "*.bin" -o -name "*.gz" 2>/dev/null | head -10
            
            exit 0
        else
            echo "=== Build Failed ==="
            
            # 保存错误信息
            echo "=== Last 50 lines of build log ==="
            if [ -f "build.log" ]; then
                tail -50 build.log
            else
                echo "No build log found"
            fi
            
            # 检查磁盘空间状态
            echo "=== Final Disk Space ==="
            df -h
            
            exit 1
        fi
        EOF
        
        chmod +x build_with_monitor.sh
        # 执行构建脚本并记录输出
        ./build_with_monitor.sh
        
    - name: Clean up build artifacts to save space
      if: always()
      run: |
        cd openwrt
        echo "=== Cleaning Build Artifacts ==="
        
        # 保留最终镜像，删除中间文件
        if [ -d "bin/targets" ]; then
            echo "Keeping target binaries, size:"
            du -sh bin/targets
            
            # 删除构建目录
            rm -rf build_dir/*
            rm -rf staging_dir/*
            rm -rf tmp/*
            
            echo "Space after cleanup:"
            df -h
        else
            echo "No target binaries found, skipping cleanup"
        fi
        
    - name: Upload artifacts with compression
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-${{ github.event.inputs.version || env.OPENWRT_VERSION }}-x86_64-complete
        path: |
          openwrt/bin/targets/x86/64/*.gz
          openwrt/bin/targets/x86/64/*.bin
          openwrt/bin/targets/x86/64/*.img
        retention-days: 7
        compression-level: 9

    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-failure-logs
        path: |
          openwrt/.config
          openwrt/build.log
        retention-days: 7

    - name: Final disk space report
      if: always()
      run: |
        echo "=== Final Disk Space Report ==="
        df -h
        echo "=== Build Summary ==="
        echo "Status: ${{ job.status }}"
        if [ -d "openwrt/bin/targets" ]; then
            echo "✅ Build artifacts generated"
            echo "Artifacts:"
            ls -la openwrt/bin/targets/x86/64/ 2>/dev/null | head -10 || echo "No binaries found in expected location"
        else
            echo "❌ No build artifacts"
        fi
        echo "OpenWrt Version: ${{ github.event.inputs.version || env.OPENWRT_VERSION }}"
        echo "Features: Complete plugin set with Chinese language support"