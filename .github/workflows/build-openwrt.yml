name: Build OpenWrt x86 with Custom Packages

on:
  workflow_dispatch:
    inputs:
      skip_checks:
        description: 'Skip dependency checks'
        required: false
        default: false
        type: boolean

env:
  REPO_URL: https://github.com/openwrt/openwrt.git
  REPO_BRANCH: v23.05.6
  FEEDS_CONF: feeds.conf.default

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 180

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget \
          qemu-utils \
          subversion \
          sudo
        echo "Environment setup completed"

    - name: Clone OpenWrt source
      run: |
        git clone --depth=1 --branch $REPO_BRANCH $REPO_URL openwrt
        cd openwrt

    - name: Configure feeds
      working-directory: ./openwrt
      run: |
        cat > $FEEDS_CONF << EOF
        src-git packages https://git.openwrt.org/feed/packages.git;openwrt-23.05
        src-git luci https://git.openwrt.org/project/luci.git;openwrt-23.05
        src-git routing https://git.openwrt.org/feed/routing.git;openwrt-23.05
        src-git telephony https://git.openwrt.org/feed/telephony.git;openwrt-23.05
        src-git base https://git.openwrt.org/feed/base.git;openwrt-23.05
        # 第三方插件源
        src-git passwall_packages https://github.com/xiaorouji/openwrt-passwall-packages.git;main
        src-git passwall https://github.com/xiaorouji/openwrt-passwall.git;main
        src-git openclash https://github.com/vernesong/OpenClash.git;master
        src-git adguardhome https://github.com/rufengsuixing/luci-app-adguardhome.git;master
        src-git smartdns https://github.com/pymumu/smartdns.git;master
        src-git zerotier https://github.com/zerotier/openwrt-zerotier.git;master
        src-git ddns_go https://github.com/sirpdboy/luci-app-ddns-go.git;main
        src-git lucky https://github.com/sirpdboy/luci-app-lucky.git;main
        src-git netdata https://github.com/sirpdboy/luci-app-netdata.git;main
        src-git turboacc https://github.com/chenmozhijin/turboacc.git;main
        src-git autoupdate https://github.com/sirpdboy/luci-app-autoupdate.git;main
        src-git control https://github.com/sirpdboy/luci-app-control.git;main
        EOF

    - name: Update and install feeds
      working-directory: ./openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Install specific packages
      working-directory: ./openwrt
      run: |
        # 安装所有需要的包
        ./scripts/feeds install -a
        ./scripts/feeds install luci-app-adguardhome
        ./scripts/feeds install luci-app-attendedsysupgrade
        ./scripts/feeds install luci-app-autoupdate
        ./scripts/feeds install luci-app-control-webrestriction
        ./scripts/feeds install luci-app-control-weburl
        ./scripts/feeds install luci-app-ddns-go
        ./scripts/feeds install luci-app-firewall
        ./scripts/feeds install luci-app-lucky
        ./scripts/feeds install luci-app-netdata
        ./scripts/feeds install luci-app-openclash
        ./scripts/feeds install luci-app-package-manager
        ./scripts/feeds install luci-app-passwall
        ./scripts/feeds install luci-app-smartdns
        ./scripts/feeds install luci-app-ttyd
        ./scripts/feeds install luci-app-turboacc
        ./scripts/feeds install luci-app-upnp
        ./scripts/feeds install luci-app-vsftpd
        ./scripts/feeds install luci-app-wol
        ./scripts/feeds install luci-app-zerotier
        ./scripts/feeds install luci-theme-argon

    - name: Check dependencies
      working-directory: ./openwrt
      if: ${{ !inputs.skip_checks }}
      run: |
        echo "Checking dependencies..."
        make defconfig
        make -j$(nproc) tools/install
        make -j$(nproc) toolchain/install
        echo "Dependency check completed"

    - name: Configure OpenWrt
      working-directory: ./openwrt
      run: |
        # 应用默认配置
        make defconfig
        
        # 配置目标系统
        sed -i 's/CONFIG_TARGET_x86_generic_Generic/CONFIG_TARGET_x86_generic_Generic=y/g' .config
        echo "CONFIG_TARGET_x86=y" >> .config
        echo "CONFIG_TARGET_x86_64=y" >> .config
        
        # 启用大容量存储
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=2048" >> .config
        echo "CONFIG_TARGET_KERNEL_PARTSIZE=256" >> .config
        
        # 启用必要的内核模块
        echo "CONFIG_PACKAGE_kmod-usb-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-ohci=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-uhci=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> .config
        
        # 选择所有需要的包
        packages=(
          "luci-app-adguardhome"
          "luci-app-attendedsysupgrade" 
          "luci-app-autoupdate"
          "luci-app-control-webrestriction"
          "luci-app-control-weburl"
          "luci-app-ddns-go"
          "luci-app-firewall"
          "luci-app-lucky"
          "luci-app-netdata"
          "luci-app-openclash"
          "luci-app-package-manager"
          "luci-app-passwall"
          "luci-app-smartdns"
          "luci-app-ttyd"
          "luci-app-turboacc"
          "luci-app-upnp"
          "luci-app-vsftpd"
          "luci-app-wol"
          "luci-app-zerotier"
          "luci-theme-argon"
          "luci"
          "luci-compat"
          "luci-ssl"
        )
        
        for pkg in "${packages[@]}"; do
          echo "CONFIG_PACKAGE_${pkg}=y" >> .config
        done
        
        # 更新配置
        make defconfig

    - name: Build OpenWrt
      working-directory: ./openwrt
      continue-on-error: false
      run: |
        # 开始编译，启用详细输出
        echo "Starting build process..."
        make -j$(nproc) V=s 2>&1 | tee build.log || {
          echo "Build failed, creating error log..."
          tail -n 500 build.log > build_error.log
          exit 1
        }

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: openwrt-x86-64-images
        path: |
          openwrt/bin/targets/x86/64/*.img.gz
          openwrt/bin/targets/x86/64/*.kernel
          openwrt/bin/targets/x86/64/sha256sums
        retention-days: 7

    - name: Upload build log on failure
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-error-logs
        path: |
          openwrt/build.log
          openwrt/build_error.log
        retention-days: 7

    - name: Cleanup on success
      if: success()
      run: |
        echo "Build completed successfully!"
        du -sh openwrt/bin/targets/x86/64/*

    - name: Notify failure
      if: failure()
      run: |
        echo "Build failed! Check the build-error-logs artifact for details."
        exit 1
