name: Build OpenWrt x86_64 with Custom Packages

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenWrt Version'
        required: true
        default: 'v24.10.4'
        type: string
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * 0'

env:
  OPENWRT_VERSION: "v24.10.4"
  TARGET: "x86/64"
  SUBTARGET: "generic"
  PROFILE: "generic"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Check build environment
      run: |
        echo "=== Checking Build Environment ==="
        df -h
        echo "Available disk space:"
        df -h /dev/root | tail -1
        echo "Memory info:"
        free -h
        echo "CPU info:"
        nproc
        echo "=== Installing Dependencies ==="
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          gcc \
          g++ \
          binutils \
          patch \
          bzip2 \
          flex \
          make \
          libncurses5-dev \
          libncursesw5-dev \
          zlib1g-dev \
          gawk \
          git \
          gettext \
          xsltproc \
          rsync \
          wget \
          unzip \
          python3 \
          python3-setuptools \
          python3-pip \
          libssl-dev \
          libelf-dev \
          quilt \
          bc \
          dos2unix \
          file
        echo "=== Environment Check Complete ==="
        
    - name: Clone OpenWrt source
      run: |
        echo "=== Cloning OpenWrt Source ==="
        git clone https://git.openwrt.org/openwrt/openwrt.git openwrt
        cd openwrt
        git checkout ${{ env.OPENWRT_VERSION }}
        echo "OpenWrt version:"
        git describe --tags
        cd ..
        
    - name: Prepare build environment
      run: |
        cd openwrt
        echo "=== Preparing Build Environment ==="
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Add third-party feeds
      run: |
        cd openwrt
        echo "=== Adding Third-party Feeds ==="
        
        # æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº
        cat >> feeds.conf.default << EOF
        src-git passwall https://github.com/xiaorouji/openwrt-passwall;packages
        src-git passwall2 https://github.com/xiaorouji/openwrt-passwall2;main
        src-git openclash https://github.com/vernesong/OpenClash;master
        src-git adguardhome https://github.com/rufengsuixing/luci-app-adguardhome;master
        src-git smartdns https://github.com/pymumu/openwrt-smartdns;master
        src-git sirpdboy https://github.com/sirpdboy/openwrt-package;main
        src-git jerrykuku https://github.com/jerrykuku/openwrt-package;master
        src-git kenzo https://github.com/kenzok8/openwrt-packages;master
        src-git small https://github.com/kenzok8/small;master
        EOF
        
        # æ›´æ–°æ‰€æœ‰feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Configure build
      run: |
        cd openwrt
        echo "=== Configuring Build ==="
        
        # åˆ›å»ºé»˜è®¤é…ç½®
        make defconfig
        
        # é…ç½®ç›®æ ‡å¹³å°
        sed -i 's/CONFIG_TARGET_x86_generic_Generic/CONFIG_TARGET_x86_generic_Generic=y/g' .config
        sed -i 's/CONFIG_TARGET_x86=y/CONFIG_TARGET_x86=y/g' .config
        sed -i 's/CONFIG_TARGET_x86_64=y/CONFIG_TARGET_x86_64=y/g' .config
        
        # å¯ç”¨å¤§å®¹é‡å­˜å‚¨
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=1024" >> .config
        echo "CONFIG_TARGET_KERNEL_PARTSIZE=256" >> .config
        
        # å¯ç”¨å¿…è¦çš„å†…æ ¸æ¨¡å—
        echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-vfat=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-ohci=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-uhci=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        
        # é…ç½®æ’ä»¶
        echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-attendedsysupgrade=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-autoupdate=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-control-webrestriction=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-control-weburl=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ddns-go=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-firewall=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-lucky=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-netdata=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-package-manager=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-smartdns=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-vsftpd=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-wol=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-zerotier=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        
        # å¯ç”¨LuCI
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-ssl=y" >> .config
        echo "CONFIG_LUCI_LANG_zh_Hans=y" >> .config
        
        # æ£€æŸ¥é…ç½®
        make defconfig
        echo "=== Configuration Complete ==="
        
    - name: Check dependencies
      run: |
        cd openwrt
        echo "=== Checking Dependencies ==="
        make -j$(nproc) tools/install
        make -j$(nproc) toolchain/install
        echo "=== Dependency Check Complete ==="
        
    - name: Download packages
      run: |
        cd openwrt
        echo "=== Downloading Packages ==="
        make -j$(nproc) download
        echo "=== Package Download Complete ==="
        
    - name: Build OpenWrt
      run: |
        cd openwrt
        echo "=== Starting Build Process ==="
        # ä½¿ç”¨è¯¦ç»†è¾“å‡ºä»¥ä¾¿è°ƒè¯•
        make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log || {
          echo "=== Build Failed - Creating Error Log ==="
          tail -100 build.log > build_error.log
          exit 1
        }
        echo "=== Build Successful ==="
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: openwrt-${{ env.OPENWRT_VERSION }}-x86_64
        path: |
          openwrt/bin/targets/x86/64/*
        retention-days: 7
        
    - name: Upload build log on failure
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-error-logs
        path: |
          openwrt/build.log
          openwrt/build_error.log
        retention-days: 30

    - name: Generate build summary
      if: always()
      run: |
        echo "=== Build Summary ==="
        echo "OpenWrt Version: ${{ env.OPENWRT_VERSION }}"
        echo "Target: ${{ env.TARGET }}"
        echo "Profile: ${{ env.PROFILE }}"
        echo "Build Status: ${{ job.status }}"
        echo "=== Repository Structure ==="
        echo "ğŸ“¦ OpenWrt Build Repository"
        echo "â”œâ”€â”€ ğŸ“ .github/workflows/"
        echo "â”‚   â””â”€â”€ build-openwrt.yml    # GitHub Actions å·¥ä½œæµ"
        echo "â”œâ”€â”€ ğŸ“ openwrt/              # OpenWrt æºç ç›®å½•"
        echo "â”‚   â”œâ”€â”€ ğŸ“ feeds/            # è½¯ä»¶æº"
        echo "â”‚   â”œâ”€â”€ ğŸ“ package/          # è½¯ä»¶åŒ…"
        echo "â”‚   â”œâ”€â”€ ğŸ“ target/           # ç›®æ ‡å¹³å°é…ç½®"
        echo "â”‚   â””â”€â”€ .config              # ç¼–è¯‘é…ç½®"
        echo "â””â”€â”€ ğŸ“„ README.md             # é¡¹ç›®è¯´æ˜"
        
        echo "=== Included Packages ==="
        echo "ğŸ”§ Core: luci, luci-ssl"
        echo "ğŸ¨ Theme: luci-theme-argon"
        echo "ğŸ›¡ï¸ Security: adguardhome, passwall, openclash, smartdns"
        echo "ğŸŒ Network: ddns-go, zerotier, lucky, turboacc"
        echo "ğŸ› ï¸ Tools: ttyd, netdata, wol, upnp, vsftpd"
        echo "âš™ï¸ System: autoupdate, package-manager, attendedsysupgrade"
        echo " parental-control: webrestriction, weburl"