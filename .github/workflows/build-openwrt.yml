name: Build OpenWrt x86_64 with Disk Space Optimization

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenWrt Version'
        required: true
        default: 'v24.10.4'
        type: string
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * 0'

env:
  OPENWRT_VERSION: "v24.10.4"
  TARGET: "x86/64"
  SUBTARGET: "generic"
  PROFILE: "generic"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: Check available disk space
      run: |
        echo "=== Initial Disk Space Check ==="
        df -h
        echo "Available space in /home/runner:"
        df -h /home/runner | tail -1
        echo "Available space in /:"
        df -h / | tail -1
        
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install only essential dependencies
      run: |
        echo "=== Installing Essential Dependencies ==="
        sudo apt-get update
        # 清理apt缓存
        sudo apt-get clean
        
        # 只安装最必要的依赖
        sudo apt-get install -y \
          build-essential \
          clang \
          gcc \
          g++ \
          binutils \
          patch \
          bzip2 \
          flex \
          make \
          libncurses5-dev \
          zlib1g-dev \
          gawk \
          git \
          gettext \
          xsltproc \
          rsync \
          wget \
          unzip \
          python3 \
          python3-pip \
          libssl-dev \
          libelf-dev \
          quilt \
          bc \
          file
        
        # 清理临时文件
        sudo apt-get autoremove -y
        sudo apt-get clean
        
    - name: Clone OpenWrt source with shallow clone
      run: |
        echo "=== Cloning OpenWrt Source (Shallow) ==="
        # 使用浅克隆减少磁盘使用
        git clone --depth 1 --branch ${{ env.OPENWRT_VERSION }} \
          https://git.openwrt.org/openwrt/openwrt.git openwrt
        cd openwrt
        echo "OpenWrt version:"
        git describe --tags || echo "Shallow clone, using branch ${{ env.OPENWRT_VERSION }}"
        
    - name: Clean up space before build
      run: |
        echo "=== Cleaning Disk Space Before Build ==="
        df -h
        
        # 清理各种缓存
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/graalvm
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo rm -rf /opt/microsoft
        sudo rm -rf /usr/local/lib/android
        
        # 清理日志文件
        sudo find /var/log -type f -name "*.log" -exec truncate -s 0 {} \;
        
        echo "Space after cleanup:"
        df -h
        
    - name: Configure minimal OpenWrt build
      run: |
        cd openwrt
        echo "=== Configuring Minimal Build ==="
        
        # 更新基础feeds（不使用第三方feeds以减少空间）
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 创建默认配置
        make defconfig
        
        # 配置目标平台
        echo "CONFIG_TARGET_x86=y" >> .config
        echo "CONFIG_TARGET_x86_64=y" >> .config
        echo "CONFIG_TARGET_x86_64_Generic=y" >> .config
        
        # 使用较小的分区大小
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=512" >> .config
        echo "CONFIG_TARGET_KERNEL_PARTSIZE=128" >> .config
        
        # 只启用最必要的内核模块
        echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config
        
        # 只选择核心插件（减少数量）
        echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-firewall=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-smartdns=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-wol=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-zerotier=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        
        # 启用LuCI核心
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-ssl=y" >> .config
        
        # 禁用调试信息以节省空间
        echo "CONFIG_DEBUG_INFO=n" >> .config
        echo "CONFIG_DEBUG=y" >> .config
        
        # 检查配置
        make defconfig
        
        echo "=== Minimal Configuration Complete ==="
        echo "Selected packages:"
        grep "^CONFIG_PACKAGE" .config | head -20
        
    - name: Download packages with cleanup
      run: |
        cd openwrt
        echo "=== Downloading Packages ==="
        
        # 只下载必要的包
        make -j2 download
        
        echo "=== Package Download Complete ==="
        echo "Download cache size:"
        du -sh dl/ || echo "dl directory not found"
        
    - name: Build with space optimization
      run: |
        cd openwrt
        echo "=== Starting Optimized Build ==="
        
        # 监控磁盘空间
        df -h
        
        # 创建构建脚本，包含空间监控
        cat > build_with_monitor.sh << 'EOF'
        #!/bin/bash
        set -e
        
        # 磁盘空间监控函数
        monitor_space() {
            while true; do
                echo "=== Disk Space Monitor ==="
                df -h /home/runner
                sleep 30
            done
        }
        
        # 启动监控后台进程
        monitor_space &
        MONITOR_PID=$!
        
        # 构建函数
        build_openwrt() {
            echo "=== Building Toolchain ==="
            make -j2 tools/install
            
            echo "=== Building Target ==="
            # 使用更少的并行进程和减少日志输出
            make -j2 2>&1 | grep -E "error|warning|Building|Installing" || true
            
            # 检查构建结果
            if [ -f "bin/targets/x86/64/openwrt-x86-64-generic-kernel.bin" ]; then
                echo "✅ Build successful!"
                return 0
            else
                echo "❌ Build failed!"
                return 1
            fi
        }
        
        # 执行构建
        if build_openwrt; then
            # 停止监控
            kill $MONITOR_PID 2>/dev/null || true
            echo "=== Build Completed Successfully ==="
            exit 0
        else
            # 停止监控
            kill $MONITOR_PID 2>/dev/null || true
            echo "=== Build Failed ==="
            
            # 保存错误信息
            echo "=== Last 50 lines of build log ==="
            tail -50 build.log 2>/dev/null || echo "No build log found"
            
            # 检查磁盘空间状态
            echo "=== Final Disk Space ==="
            df -h
            
            exit 1
        fi
        EOF
        
        chmod +x build_with_monitor.sh
        ./build_with_monitor.sh
        
    - name: Clean up build artifacts to save space
      if: always()
      run: |
        cd openwrt
        echo "=== Cleaning Build Artifacts ==="
        
        # 保留最终镜像，删除中间文件
        if [ -d "bin/targets" ]; then
            echo "Keeping target binaries, size:"
            du -sh bin/targets
            
            # 删除构建目录
            rm -rf build_dir/*
            rm -rf staging_dir/*
            rm -rf tmp/*
            
            echo "Space after cleanup:"
            df -h
        else
            echo "No target binaries found, skipping cleanup"
        fi
        
    - name: Upload artifacts with compression
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-${{ env.OPENWRT_VERSION }}-x86_64-minimal
        path: |
          openwrt/bin/targets/x86/64/*.gz
          openwrt/bin/targets/x86/64/*.bin
          openwrt/bin/targets/x86/64/*.img
        retention-days: 7
        compression-level: 9

    - name: Upload minimal logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-failure-minimal
        path: |
          openwrt/.config
        retention-days: 7

    - name: Final disk space report
      if: always()
      run: |
        echo "=== Final Disk Space Report ==="
        df -h
        echo "=== Build Summary ==="
        echo "Status: ${{ job.status }}"
        if [ -d "openwrt/bin/targets" ]; then
            echo "✅ Build artifacts generated"
            ls -la openwrt/bin/targets/x86/64/ 2>/dev/null | head -10 || echo "No binaries found"
        else
            echo "❌ No build artifacts"
        fi